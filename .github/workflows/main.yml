
name: Validate PR on develop branch

on:
    pull_request:
      types: [opened, synchronize]
      branches: [ main ]
      paths:
        - 'lostCTRL/force-app/**'
            

jobs:
     validate:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2


        - uses: actions/setup-node@v1
          with:
            node-version: '>=14'
            check-latest: true

        - name: Install Salesforce CLI
          run: |
            wget https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
            mkdir sfdx-cli
            tar xJf sfdx-linux-amd64.tar.xz -C sfdx-cli --strip-components 1
            ./sfdx-cli/install


        - name: install sfdx powerkit
          run: echo 'y' | sfdx plugins:install sfpowerkit

        - name: 'Populate auth file with SFDX_URL_PROD secret'
          shell: bash
          run: 'echo ${{secrets.SFDX_URL_PROD}} > SFDX_PROD'

        - name: 'Fetch Repository'
          run: |
            git remote set-branches origin '*'
            git fetch
            git branch

        - name: Get List of Modified Metadata
          run: sfdx sfpowerkit:project:diff --revisionfrom lostCTRL/ --output ./diff_output

        - name: 'Authenticate to Production Org'
          run: sfdx auth:sfdxurl:store -f SFDX_PROD -s -a production

        - name: 'Run validation deployment'
          run: sfdx force:source:deploy -p ./diff_output/force-app/main/default --checkonly --testlevel RunLocalTests
